---
title: "Darwin Core mapping"
subtitle: "For: National checklists and red lists for prioritising European butterfly conservation actions"
author:
- Lien Reyserhove
- Dimitri Brosens
- Peter Desmet
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    number_sections: true
    toc: true
    toc_depth: 3
    toc_float: true
---

This document describes how we map the checklist data to Darwin Core. The source file for this document can be found [here](https://github.com/inbo/butterflies-europe-checklist/blob/master/src/dwc_mapping.Rmd).

# Setup

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

Load libraries:

```{r}
library(tidyverse)      # To do data science
library(magrittr)       # To use %<>% pipes
library(here)           # To find files
library(janitor)        # To clean input data
library(googlesheets)   # To import and read Google spreadsheets 
library(digest)         # To generate hashes
library(rgbif)          # To use GBIF services
```

# Read source data

The original spreadsheet can be found [here](https://docs.google.com/spreadsheets/d/1RvxpOYf2ZrTu9nsTLumoi-G-GGhh6_lV37TNtPiVES4/edit?usp=sharing).

Retrieve the spreadsheet:

```{r connect_google_spreadsheets}
retrieve_spreadsheet <- gs_title("EuroButt")
```

This spreadsheet contains four relevant different worksheets to read:

```{r}
taxa_regional <- retrieve_spreadsheet %>% gs_read("taxa_regional") 
regional_threat_scores <- retrieve_spreadsheet %>% gs_read("regional_threat_scores")
references <- retrieve_spreadsheet %>% gs_read("references")
country_info <- retrieve_spreadsheet %>% gs_read("country_info")
```

We want to add a copy of the source data to the repository:

```{r}
write_csv(taxa_regional, here("data", "raw", "taxa_regional.csv"), na = "")
write_csv(regional_threat_scores, here("data", "raw", "regional_threat_scores.csv"), na = "")
write_csv(references, here("data", "raw", "references.csv"), na = "")
write_csv(country_info, here("data", "raw", "country_info.csv"), na = "")
```

`taxa_regional` and `references` will be used for the Darwin Core mapping, while `country_info` is need for calculation in `wrl_values.Rmd`.

# Process source data

Get `taxa_regional` and join with the `references` as the basis for our mapping:

```{r}
input_data <-
  taxa_regional %>%
  left_join(references, by = c("CountryCode"))
```

## Tidy data

Clean data somewhat:

```{r}
input_data %<>%
  remove_empty("rows") %>%    # Remove empty rows
  clean_names()               # Have sensible (lowercase) column names
```

Add prefix `input_` to all column names to avoid name clashes with Darwin Core terms:

```{r}
colnames(input_data) <- paste0("input_", colnames(input_data))
```

Sort on scientific name and country code (to maintain some consistency between updates of the dataset):

```{r}
input_data %<>% arrange(input_speciesname_europe, input_country_code)
```

## Scientific names

No cleaning required.

## Taxon IDs

To link taxa with information in the extension(s), each taxon needs a unique and relatively stable `taxonID`. Here we create one in the form of `dataset_shortname:taxon:hash`, where `hash` is unique code based on scientific name (that will remain the same as long as scientific name remains the same):

```{r}
vdigest <- Vectorize(digest) # Vectorize digest function to work with vectors
input_data %<>% mutate(input_taxon_id = paste(
  "butterflies-europe-checklist",
  "taxon",
  vdigest(paste(input_speciesname_europe), algo = "md5"),
  sep = ":"
))
```

## Preview data

Show the number of species and distributions:

```{r}
input_data %>%
  summarize(
    `# taxa` = n_distinct(input_taxon_id),
    `# distributions` = n()
  ) %>%
  adorn_totals("row")
```

Preview data:

```{r}
input_data %>% head()
```

# Taxon core

## Pre-processing

Create a dataframe with unique taxa only (ignoring multiple distribution rows):

```{r start_taxon}
taxon <- input_data %>% distinct(input_taxon_id, .keep_all = TRUE)
```

### Term mapping

Map the data to [Darwin Core Taxon](http://rs.gbif.org/core/dwc_taxon_2015-04-24.xml).
 
### language

```{r}
taxon %<>% mutate(language = "en")
```

### license

```{r}
taxon %<>% mutate(license = "http://creativecommons.org/publicdomain/zero/1.0/")
```

### rightsHolder

```{r}
taxon %<>% mutate(rightsHolder = "INBO")
```

### accessRights

```{r}
taxon %<>% mutate(accessRights = "https://www.inbo.be/en/norms-data-use")
```

### datasetID

```{r}
taxon  %<>% mutate(datasetID = "to_be_completed")
```

### institutionCode

```{r}
taxon %<>% mutate(institutionCode = "INBO")
```

### datasetName

```{r}
taxon %<>% mutate(datasetName = "National checklists and red lists for prioritising European butterfly conservation actions")
```

### taxonID

```{r}
taxon %<>% mutate(taxonID = input_taxon_id)
```

### scientificName

```{r}
taxon %<>% mutate(scientificName = input_speciesname_europe)
```

### kingdom

```{r}
taxon %<>% mutate(kingdom = "Animalia")
```

### phylum

```{r}
taxon %<>% mutate(phylum = "Arthropoda")
```

### class

```{r}
taxon %<>% mutate(class = "Insecta")
```

### order

```{r}
taxon %<>% mutate(order= "Lepidoptera")
```

### taxonRank

```{r}
taxon %<>% mutate(taxonRank = "species")
```

### nomenclaturalCode

```{r}
taxon %<>% mutate(nomenclaturalCode = "ICZN")
```

## Post-processing

Remove the original columns:

```{r}
taxon %<>% select(-starts_with("input_"))
```

Preview data:

```{r}
taxon %>% head()
```

Save to CSV:

```{r}
write_csv(taxon, here("data", "processed", "taxon.csv"), na = "")
```

# Create distribution extension

```{r start_distribution}
distribution <- raw_data
head(distribution)
```

## Term mapping

Map the data to [Species Distribution](http://rs.gbif.org/extension/gbif/1.0/distribution.xml).

### taxonID

```{r}
distribution %<>% mutate(taxonID = raw_taxon_id) 
```

### locality

```{r}
distribution %<>% mutate(locality = raw_country) 
```

### countryCode

```{r}
distribution %<>% mutate(countryCode = raw_country_code)

```

### threatStatus

```{r}
distribution %<>% mutate(threatStatus = raw_red_list_category)
  
```

### establishmentMeans

```{r}
distribution %<>% 
  mutate(establishmentMeans = raw_status) %>%
  mutate(establishmentMeans = recode(establishmentMeans
            ,"Breeding"="native"
            ,"NeedsConfirmation"="uncertain")) 

```

### source

```{r}
distribution %<>% mutate(source = raw_reference_red_list)
```

## Post-processing

Remove the original columns:

```{r}
distribution %<>% select(-starts_with("raw_"))
```

Sort on `taxonID`:

```{r}
distribution %<>% arrange(taxonID)
```

Preview data:

```{r}
distribution %>% head()
```

Save to CSV:

```{r}
write.csv(distribution, file = dwc_distribution_file, na = "", row.names = FALSE, fileEncoding = "UTF-8")
```

