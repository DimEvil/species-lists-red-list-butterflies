---
title: "Darwin Core mapping"
subtitle: "For: National checklists and red lists for prioritising European butterfly conservation actions"
author:
- Lien Reyserhove
- Dimitri Brosens
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
---

This document describes how we map the checklist data to Darwin Core. 

# Setup

```{r setup, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

Set locale (so we use UTF-8 character encoding):

```{r}
# This works on Mac OS X, might not work on other OS
Sys.setlocale("LC_CTYPE", "en_US.UTF-8")
```

Load libraries:

```{r eval = FALSE}

library(tidyverse)        # For data transformations
library(magrittr)         # For %<>% pipes
library(googlesheets)     # To import and read Google spreadsheets 
library(janitor)          # For cleaning input data
library(digest)           # To generate hashes
```

Set file paths (all paths should be relative to this script):

```{r}
# Interim files:
taxa_regional_file = "../data/interim/taxa_regional.csv"
regional_threat_scores_file = "../data/interim/regional_threat_scores.csv"
references_file = "../data/interim/references.csv"

# Processed files:
dwc_taxon_file = "../data/processed/dwc/taxon.csv"
dwc_distribution_file = "../data/processed/dwc/distribution.csv"
```

# Read raw data

The original spreadsheet can be found [here](https://docs.google.com/spreadsheets/d/1RvxpOYf2ZrTu9nsTLumoi-G-GGhh6_lV37TNtPiVES4/edit?ts=5b1f937f#gid=1323544344). We need to retrieve this spreadsheet and select the specific Googlesheet:

```{r}
retrieve_spreadsheet <- gs_title("EuroButt")
```

This spreadsheet contains three relevant different worksheets: `taxa_regional`, `regional_threat_scores` and `references`. We select these here and save them as separate data frames. We will then continue with the `taxa_regional` as this the original dataframe.

```{r}
taxa_regional <- retrieve_spreadsheet %>% gs_read("taxa_regional") 
regional_threat_scores <- retrieve_spreadsheet %>% gs_read("regional_threat_scores")
references <- retrieve_spreadsheet %>% gs_read("references")
```

We add a copy of the generated data frames to the [interim folder](https://github.com/inbo/red-lists-european-butterflies-checklist/tree/master/data/interim) on Github:

```{r}
write.csv(taxa_regional, file = taxa_regional_file, na = "", row.names = FALSE, fileEncoding = "UTF-8")
write.csv(regional_threat_scores, file = regional_threat_scores_file, na = "", row.names = FALSE, fileEncoding = "UTF-8")
write.csv(references, file = references_file, na = "", row.names = FALSE, fileEncoding = "UTF-8")
```

Create a data frame `raw_data` from `taxa_regional`, which is the original dataframe and the basis for the mapping of the checklist:

```{r}
raw_data <- taxa_regional
```

# Pre-processing

## Join references:

```{r}
raw_data <- taxa_regional %>% left_join(references, by = c("CountryCode"))
```

## Create taxonID

```{r}
# Vectorize the digest function (The digest() function isn't vectorized. So if you pass in a vector, you get one value for the whole vector rather than a digest for each element of the vector):
vdigest <- Vectorize(digest)

raw_data %<>% mutate(taxonID = paste("red-lists-european-butterflies-checklist", "taxon", vdigest (SpeciesnameEurope, algo="md5"), sep=":"))
```

## Further pre-processing

Clean data somewhat

```{r}
raw_data %<>%
  remove_empty("rows") %>%    # Remove empty rows
  clean_names()               # Have sensible (lowercase) column names
```

Add prefix `raw_` to all column names to avoid name clashes with Darwin Core terms:

```{r}
colnames(raw_data) <- paste0("raw_", colnames(raw_data))
```
 
Preview data:

```{r}
head(raw_data, n = 100)
```

## Create taxon core

```{r}
taxon <- raw_data
```

### Pre-processing

Use unique values in taxon

```{r}
taxon %<>% 
  filter(raw_use == 'y') %>%
  select(raw_speciesname_local, raw_speciesname_europe, raw_country, raw_taxon_id, raw_use, raw_reference_species_list, raw_reference_red_list) %>%
  distinct(raw_taxon_id, .keep_all = TRUE)
```

### Term mapping

Map the data to [Darwin Core Taxon](http://rs.gbif.org/core/dwc_taxon_2015-04-24.xml).
 
### language

```{r}
taxon %<>% mutate(language = "en")
```

### license

```{r}
taxon %<>% mutate(license = "http://creativecommons.org/publicdomain/zero/1.0/")
```

### rightsHolder

```{r}
taxon %<>% mutate(rightsHolder = "INBO")  
```

### datasetID

```{r}
taxon  %<>% mutate(datasetID = "to_be_completed")
```

### accessRights

```{r}
taxon %<>% mutate(accessRights = "https://www.inbo.be/en/norms-data-use") 
```

### references 

```{r}
taxon %<>% mutate(references = raw_reference_species_list) 
```

### institutionCode

```{r}
taxon %<>% mutate(institutionCode = "INBO") 
```

### datasetName

```{r}
taxon %<>% mutate(datasetName = "National checklists and red lists for prioritising European butterfly conservation actions")
```

### taxonID

```{r}
taxon %<>% mutate(taxonID = raw_taxon_id) 
```

### scientificName

```{r}
taxon %<>% mutate(scientificName = raw_speciesname_europe) 
```

### kingdom

```{r}
taxon %<>% mutate(kingdom = "Animalia")
```

### class

```{r}
taxon %<>% mutate(class = "Insecta") 
```

### order

```{r}
taxon %<>% mutate (order= "Lepidoptera")
```

### taxonRank

```{r}
taxon %<>% mutate(taxonRank = "species")
```

### nomenclaturalCode

```{r}
taxon %<>% mutate(nomenclaturalCode = "ICZN")
```

## Post-processing

Remove the original columns:

```{r}
taxon %<>% select(-starts_with("raw_"))
```

Sort on `taxonID`:

```{r}
taxon %<>% arrange(taxonID)
```

Preview data:

```{r}
head(taxon)
```

Save to CSV:

```{r}
write.csv(taxon, file = dwc_taxon_file, na = "", row.names = FALSE, fileEncoding = "UTF-8")
```

# Create distribution extension

```{r start_distribution}
distribution <- raw_data
head(distribution)
```

### Pre-processing

Use unique values in taxon

```{r}
distribution %<>% 
  filter(raw_use == 'y') %>% 
  select(raw_speciesname_europe, raw_taxon_id, raw_country, raw_country_code, raw_red_list_category, raw_comments, raw_status, raw_reference_red_list) 
```

## Term mapping

Map the data to [Species Distribution](http://rs.gbif.org/extension/gbif/1.0/distribution.xml).

### taxonID

```{r}
distribution %<>%
    rename(scientificName = raw_speciesname_europe) 
distribution %<>% mutate(taxonID = raw_taxon_id) 
```


### locationID

### locality


### countryCode


```{r}
distribution %<>%
      rename(countryCode = raw_country_code)

```

### establishmentMeans


```{r}
distribution %<>%
      rename(establishmentMeans = raw_status)

```
## renaming



```{r}
distribution %<>%
      rename(source = raw_reference_red_list)

```

### occurrenceStatus


### treadStatus


```{r}
distribution %<>%
      rename(treadStatus = raw_red_list_category)

```


### eventDate
### source

## Post-processing

Remove the original columns:

```{r}
distribution %<>% select(-starts_with("raw_"))
```

Sort on `taxonID`:

```{r}
distribution %<>% arrange(taxonID)
```

Preview data:

```{r}
distribution %>%
 # mutate(source = substr(source, 1, 10)) %>% # Shorten source to make it easier to display
  head()
```

Save to CSV:

```{r}
write.csv(distribution, file = dwc_distribution_file, na = "", row.names = FALSE, fileEncoding = "UTF-8")

```

