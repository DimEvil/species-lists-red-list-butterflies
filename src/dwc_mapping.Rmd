---
title: "Darwin Core mapping"
subtitle: "For: National checklists and red lists for prioritising European butterfly conservation actions"
author:
- Peter Desmet
- Dimitri Brosens
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
---

This document describes how we map the checklist data to Darwin Core. The source file for this document can be found [here](https://github.com/inbo/eurobutt-checklist/blob/master/src/dwc_mapping.Rmd).

# Setup

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

Load libraries:

```{r}
library(tidyverse)      # To do data science
library(tidylog)        # To provide feedback on dplyr functions
library(magrittr)       # To use %<>% pipes
library(here)           # To find files
library(janitor)        # To clean input data
library(digest)         # To generate hashes
library(rgbif)          # To use GBIF services
```

# Read source data

The original spreadsheet can be found [here](https://docs.google.com/spreadsheets/d/1RvxpOYf2ZrTu9nsTLumoi-G-GGhh6_lV37TNtPiVES4/edit?usp=sharing).

Read the relevant worksheets:

```{r}
input_distribution <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSrKN8_XbQ4Vo-VrtUiqAtS5im3QxkHBNSJHPSLmrkM5C1PIC7DOg-oboRcEJZtWp_qsi802YRlRp8C/pub?gid=979140000&single=true&output=csv")
input_taxa <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSrKN8_XbQ4Vo-VrtUiqAtS5im3QxkHBNSJHPSLmrkM5C1PIC7DOg-oboRcEJZtWp_qsi802YRlRp8C/pub?gid=1559651428&single=true&output=csv")
input_regions <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSrKN8_XbQ4Vo-VrtUiqAtS5im3QxkHBNSJHPSLmrkM5C1PIC7DOg-oboRcEJZtWp_qsi802YRlRp8C/pub?gid=2076261682&single=true&output=csv")
input_references <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSrKN8_XbQ4Vo-VrtUiqAtS5im3QxkHBNSJHPSLmrkM5C1PIC7DOg-oboRcEJZtWp_qsi802YRlRp8C/pub?gid=1083424499&single=true&output=csv")
input_rlc <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSrKN8_XbQ4Vo-VrtUiqAtS5im3QxkHBNSJHPSLmrkM5C1PIC7DOg-oboRcEJZtWp_qsi802YRlRp8C/pub?gid=1579699417&single=true&output=csv")
```

Sort the source files (to maintain some consistency between updates of the dataset):

```{r}
input_distribution %<>% arrange(scientific_name, region_code)
input_taxa %<>% arrange(scientific_name)
input_regions %<>% arrange(region_code)
input_references %<>% arrange(region_code, citation)
input_rlc %<>% arrange(country_code, rlc)
```

Copy the source data to the repository:

```{r}
write_csv(input_distribution, here("data", "raw", "distribution.csv"), na = "")
write_csv(input_taxa, here("data", "raw", "taxa.csv"), na = "")
write_csv(input_regions, here("data", "raw", "regions.csv"), na = "")
write_csv(input_references, here("data", "raw", "references.csv"), na = "")
write_csv(input_rlc, here("data", "raw", "rlc.csv"), na = "")
```

The first 4 files will be used for the Darwin Core mapping, while `rlc` is needed for the calculation in `wrl_values.Rmd`.

# Process source data

The `input_references` contain references of species/red lists per region. We can include those as `source` for distributions, but unfortunately not as full references in a [reference extension](http://rs.gbif.org/extension/gbif/1.0/references.xml), as that would require them to be associated (and repeated) with taxa.

Group `references` to create a concatenated list of unique references per `region_code`, e.g. `AD` = `ƒêug (2013) | Koren and Kulijer (2016) | Lelo (2016)`. References that act as both red and species list reference, will only be listed once:

```{r}
grouped_references <-
  input_references %>%
  arrange(region_code, citation_type, citation) %>%
  group_by(region_code) %>%
  summarize(reference = paste(unique(citation), collapse = " | "))
```

Start from distributions and join with taxon, region and grouped references information (which should result in the same number of rows as distributions):

```{r}
input_data <-
  input_distribution %>%
  left_join(input_taxa, on = "scientific_name") %>%
  left_join(input_regions, on = "region_code") %>%
  left_join(grouped_references, on = "region_code")
```

## Tidy data

Clean data somewhat:

```{r}
input_data %<>%
  remove_empty("rows") %>%    # Remove empty rows
  clean_names()               # Have sensible (lowercase) column names
```

Sort on scientific name and country code (to maintain some consistency between updates of the dataset):

```{r}
input_data %<>% arrange(scientific_name, region_code)
```

## Scientific names

No cleaning required.

## Taxon IDs

To link taxa with information in the extension(s), each taxon needs a unique and relatively stable `taxonID`. Here we create one in the form of `dataset_shortname:taxon:hash`, where `hash` is unique code based on scientific name (that will remain the same as long as scientific name remains the same):

```{r}
vdigest <- Vectorize(digest) # Vectorize digest function to work with vectors
input_data %<>% mutate(taxon_id = paste(
  "eurobutt-checklist",
  "taxon",
  vdigest(paste(scientific_name), algo = "md5"),
  sep = ":"
))
```

## Preview data

Show the number of species and distributions:

```{r}
input_data %>%
  group_by(family) %>%
  summarize(
    `# taxa` = n_distinct(taxon_id),
    `# distributions` = n()
  ) %>%
  adorn_totals("row")
```

Preview data:

```{r}
input_data %>% head()
```

# Taxon core

## Pre-processing

Create a dataframe with unique taxa only (ignoring multiple distribution rows):

```{r start_taxon}
taxon <- input_data %>% distinct(input_taxon_id, .keep_all = TRUE)
```

### Term mapping

Map the data to [Darwin Core Taxon](http://rs.gbif.org/core/dwc_taxon_2015-04-24.xml).
 
### language

```{r}
taxon %<>% mutate(language = "en")
```

### license

```{r}
taxon %<>% mutate(license = "http://creativecommons.org/publicdomain/zero/1.0/")
```

### rightsHolder

```{r}
taxon %<>% mutate(rightsHolder = "INBO")
```

### accessRights

```{r}
taxon %<>% mutate(accessRights = "https://www.inbo.be/en/norms-data-use")
```

### datasetID

```{r}
taxon  %<>% mutate(datasetID = "to_be_completed")
```

### institutionCode

```{r}
taxon %<>% mutate(institutionCode = "INBO")
```

### datasetName

```{r}
taxon %<>% mutate(datasetName = "National checklists and red lists for prioritising European butterfly conservation actions")
```

### taxonID

```{r}
taxon %<>% mutate(taxonID = input_taxon_id)
```

### scientificName

```{r}
taxon %<>% mutate(scientificName = input_speciesname_europe)
```

### kingdom

```{r}
taxon %<>% mutate(kingdom = "Animalia")
```

### phylum

```{r}
taxon %<>% mutate(phylum = "Arthropoda")
```

### class

```{r}
taxon %<>% mutate(class = "Insecta")
```

### order

```{r}
taxon %<>% mutate(order= "Lepidoptera")
```

### taxonRank

```{r}
taxon %<>% mutate(taxonRank = "species")
```

### nomenclaturalCode

```{r}
taxon %<>% mutate(nomenclaturalCode = "ICZN")
```

## Post-processing

Remove the original columns:

```{r}
taxon %<>% select(-starts_with("input_"))
```

Preview data:

```{r}
taxon %>% head()
```

Save to CSV:

```{r}
write_csv(taxon, here("data", "processed", "taxon.csv"), na = "")
```

# Distribution extension

## Pre-processing

Create a dataframe with all data:

```{r}
distribution <- input_data
```

## Term mapping

Map the data to [Species Distribution](http://rs.gbif.org/extension/gbif/1.0/distribution.xml).

### taxonID

```{r}
distribution %<>% mutate(taxonID = input_taxon_id) 
```

### locality

Inspect values:

```{r}
distribution %>%
  group_by(input_country_code, input_country) %>%
  count()
```

Map values:

```{r}
distribution %<>% mutate(locality = recode(input_country,
  Macaronesia_Azores = "Azores",
  Macaronesia_CanaryIslands = "Canary Islands",
  Macaronesia_MadeiraIslands = "Madeira"
))
```

Inspect mapped values: 

```{r}
distribution %>%
  filter(input_country != locality) %>%
  group_by(input_country, locality) %>%
  count()
```

### countryCode

Inspect values:

```{r}
distribution %>%
  group_by(input_country_code) %>%
  count()
```

Map values:

```{r}
distribution %<>% mutate(countryCode = recode(input_country_code,
  MA_AZ = "PT", # Azores -> Portugal
  MA_CA = "SP", # Canary Islands -> Spain
  MA_MA = "PT" # Madeira -> Portugal
))
```

Inspect mapped values: 

```{r}
distribution %>%
  filter(input_country_code != countryCode) %>%
  group_by(input_country_code, countryCode) %>%
  count()
```

### occurrenceStatus

Inspect values:

```{r}
distribution %>%
  group_by(input_status) %>%
  count()
```

Map values:

```{r}
distribution %<>% mutate(occurrenceStatus = recode(input_status,
  Ex = "absent",
  M = "absent", # Regular migrant, decided to use "absent" rather than "irregular" or "present"
  P = "present",
  .default = ""
))
```

Inspect mapped values: 

```{r}
distribution %>%
  group_by(input_status, occurrenceStatus) %>%
  count()
```

### threatStatus

Inspect values:

```{r}
distribution %>%
  group_by(input_red_list_category) %>%
  count()
```

Map values:

```{r}
distribution %<>% mutate(threatStatus = recode(input_red_list_category,
  CR = "CR", # Critically Endangered
  DD = "DD", # Data Deficient
  EN = "EN", # Endangered
  LC = "LC", # Least Concern
  NE = "NE", # Not Evaluated
  "No Red List available" = "",
  NT = "NT", # Near Threatened
  NtA = "NA", # Not Applicable
  R = "Rare", # not an official IUCN term, but used by Germany
  RE = "RE", # Regionally Extinct
  Unknown = "unknown", # not an official IUCN term, but opted to be explicit
  VU = "VU", # Vulnerable
  .default = ""
))
```

Inspect mapped values: 

```{r}
distribution %>%
  group_by(input_red_list_category, threatStatus) %>%
  count()
```

### source

Inspect values:

```{r}
distribution %>%
  group_by(input_reference_species_list, input_reference_red_list) %>%
  count()
```

Combine the references `input_reference_species_list` and `input_reference_red_list`, ignoring `NA` and using ` | ` as separator:

```{r}
distribution %<>%
  mutate(source = paste(input_reference_species_list, input_reference_red_list, sep = "; ")) %>%
  mutate(source = str_replace(source, "; NA", "")) %>% # Replace paste() output for NA values
  mutate(source = str_replace(source, "; ", " | "))
```

Inspect mapped values: 

```{r}
distribution %>%
  group_by(input_reference_species_list, input_reference_red_list, source) %>%
  count()
```

## Post-processing

Remove the original columns:

```{r}
distribution %<>% select(-starts_with("input_"))
```

Preview data:

```{r}
distribution %>% head()
```

Save to CSV:

```{r}
write_csv(distribution, here("data", "processed", "distribution.csv"), na = "")
```
