---
title: "weighted_red_list_values_script"
author: "Dimitri Brosens"
date: "18 juli 2018"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

# Load libraries

```{r warning=FALSE}
library(knitr)
opts_chunk$set(echo = TRUE)
library(dplyr)
library(readxl)
library(RODBC)
library(gam)
library(tidyverse)        # For data transformations
library(magrittr)         # For %<>% pipes
library(googlesheets)     # To import and read Google spreadsheets 
library(janitor)          # For cleaning input data
library(digest)
```


Set file paths (all paths should be relative to this script):

```{r}
# Interim files:
taxa_regional_file = "../data/interim/taxa_regional.csv"
regional_threat_scores_file = "../data/interim/regional_threat_scores.csv"
country_info_file = "../data/interim/country_info.csv"

# Processed files:

weighted_red_list_values_file = "../data/processed/weighted_red_list_values.csv"

```

# Read raw data

The original spreadsheet can be found [here](https://docs.google.com/spreadsheets/d/1RvxpOYf2ZrTu9nsTLumoi-G-GGhh6_lV37TNtPiVES4/edit?ts=5b1f937f#gid=1323544344). We need to retrieve this spreadsheet and select the specific Googlesheet:

```{r}
retrieve_spreadsheet <- gs_title("EuroButt")
```

This spreadsheet contains four relevant different worksheets: `taxa_regional`, `regional_threat_scores`, `country_info` and `references`. We select these here and save them as separate data frames. We will then continue with the `taxa_regional` as this is the original dataframe.

```{r warning=FALSE}
taxa_regional <- retrieve_spreadsheet %>% gs_read("taxa_regional") 
regional_threat_scores <- retrieve_spreadsheet %>% gs_read("regional_threat_scores")
country_info <- retrieve_spreadsheet %>% gs_read("country_info")

```

Create a data frame `raw_data` from `taxa_regional`, which is the original dataframe and the basis for the calculation of the values:

```{r}
raw_data <- taxa_regional
```

### Pre-processing

Clean data somewhat

```{r}
raw_data %<>%
  remove_empty("rows") %>%    # Remove empty rows
  clean_names()               # Have sensible (lowercase) column names
```

Add prefix `raw_` to all column names to avoid name clashes with Darwin Core terms:

```{r}
colnames(raw_data) <- paste0("raw_", colnames(raw_data))
```

Select columns for which `raw
-use = Y`:

```{r}
raw_data %<>% filter(raw_use == 'y') 
```

Preview data:

```{r}
head(raw_data, n = 100)
View(raw_data)
```

#Focus on the speciesnames used in â‚¬urope

(6371 rows)

```{r}
raw_data %<>%
  select(raw_speciesname_europe, raw_country_code, raw_red_list_category)%>%    
  group_by(raw_speciesname_europe, raw_country_code,raw_red_list_category, add = FALSE) %>%
  summarise()
head(raw_data, n=50)
View(raw_data)
```
 
 ## Join regional threat score  information

```{r}
raw_data <- raw_data %>% 
  left_join(regional_threat_scores, by = c("raw_red_list_category" = "RedListCategory","raw_country_code"="countryCode"))
View(raw_data)
```

## Calculations

Calculates species per country

```{r}
species_per_country <- raw_data %>%
  group_by(raw_country_code) %>%
  summarize(n())
  View (species_per_country)
```

calculates country per species

```{r}
country_per_species <- raw_data %>%
  group_by(raw_speciesname_europe) %>%
  summarize(n())
  View (country_per_species)
```



##Join Country Information

Species per country

```{r}
species_per_country <- species_per_country %>%
     left_join(country_info, by = c("raw_country_code"="CountryCode"))
View(species_per_country)

```

#Weighted Red list values

We calculate the mean RLC and left join the country information.

```{r}
MeanRLCValue_per_country <- raw_data %>%
      group_by (raw_country_code) %>%
      summarise_at(vars(RLCNum),funs(mean(., na.rm=TRUE))) %>%
      left_join(country_info, by = c("raw_country_code"="CountryCode"))
View(MeanRLCValue_per_country)

head(MeanRLCValue_per_country)
head(raw_data)
```

#TRying to proceed with the original script by Dirk
# Red List value per COUNTRY
Arranging dataframes according to Dirk

```{r}
MDB <- raw_data
MeanRLC <- MeanRLCValue_per_country %<>%
           drop_na(RLCNum)

MeanRLC$sqrtArea <- sqrt(MeanRLC$Area)

head(MeanRLC)
View(MeanRLC)
View(MeanRLC$sqrtArea)
```

```{r}
lmsCountry <-( MeanRLC %>%
	group_by(raw_country_code) %>%
	do(lm(RLCNum ~ 1, data = .) %>%
		 	predict.lm(., 
		 						 newdata = data.frame(RLCNum = 0,
		 						                      RLCNum = 1),
		 						 interval = "confidence",
		 						 level = 0.95) %>%
		 	as.data.frame()
	) %>%
	ungroup())
head(lmsCountry)

TableCountry <- lmsCountry %>% 
	arrange(desc(fit))
head(TableCountry)

```
```{r}
p <- ggplot(lmsCountry, aes(x = reorder(raw_country_code, -fit), y = fit)) + 
		 	geom_point() +
		 	geom_pointrange(aes(ymin = lwr, ymax = upr)) +
      xlab("CountryCode") +
      ylab("mRLV") + 
      geom_hline(yintercept = 50, size = 1, linetype = 1) + # , colour = "red"
      geom_hline(yintercept = 30, size = 1, linetype = 2) + # , colour = "orange"
      geom_hline(yintercept = 20, size = 1, linetype = 3) + # , colour = "yellow"
      theme_bw()
p

ggsave(p, file = "MeanRLCperCountry.jpg", dpi = 300, height = 5, width = 10)
```
 
 # weighted Red List value per SPECIES for Europe (sqrt area as weight)
