```{r}
library(knitr)
opts_chunk$set(echo = TRUE)
library(tidyverse)
library(dplyr)
library(readxl)
library(RODBC)
library(gam)

setwd("C:/Users/dirk_maes/Google Drive/RODELYST/EuropeseRodeLijsten/")

# Total number of countries per species
#######################################
MDB <- odbcConnectAccess2007("ButterflyRedListsEurope.accdb")
NCountries <- as.data.frame(sqlQuery(MDB, "select * from [qryNCountriesPerSpecies]"))
odbcClose(MDB)
head(NCountries)

NCountries2 <- NCountries %>% 
	group_by(SpeciesnameEurope) %>%
	summarise(NCountries = length(CountryCode))
head(NCountries2)
nrow(NCountries2)

NCountriesEU <- NCountries %>% 
	filter(!is.na(EU))
head(NCountriesEU)

NCountries2EU <- NCountriesEU %>% 
	group_by(SpeciesnameEurope) %>%
	summarise(NCountriesEU = length(CountryCode))
head(NCountries2EU)
nrow(NCountries2EU)

NCountriesEurEU <- full_join(NCountries2, NCountries2EU, by = "SpeciesnameEurope")
head(NCountriesEurEU)
nrow(NCountriesEurEU)

# Total number of species per country
#####################################
MDB <- odbcConnectAccess2007("ButterflyRedListsEurope.accdb")
NSpecies <- as.data.frame(sqlQuery(MDB, "select * from [qryNSpeciesPerCountry]"))
odbcClose(MDB)
head(NSpecies)

NCountriesSpec <- NSpecies %>% 
	group_by(Country) %>%
	summarise(NCountries = length(SpeciesnameEurope))
head(NCountriesSpec)
nrow(NCountriesSpec)

write.csv(NCountriesSpec, file = "NCountriesSpec.csv", dec = ".", row.names = FALSE, na = "0")

# Total number of Red List species per country
##############################################
NCountriesRL <- NCountries %>% 
	filter(RedListCategory == "RE" | RedListCategory == "CR" | RedListCategory == "EN" | RedListCategory == "VU") %>%
	group_by(Country) %>%
	summarise(NCountriesRL = length(SpeciesnameEurope))
head(NCountriesRL)
nrow(NCountriesRL)

write.csv(NCountriesRL, file = "NCountriesSpecRL.csv", dec = ".", row.names = FALSE, na = "0")

###############################################
# Calculate a weigthed mean for every species #
###############################################

########################################################################
MDB <- odbcConnectAccess2007("ButterflyRedListsEurope.accdb")
MeanRLC <- as.data.frame(sqlQuery(MDB, "select * from [qryWeightedMean]"))
SpeciesList <- as.data.frame(sqlQuery(MDB, "select * from [tblSpeciesListEurope2018_Condens]"))
odbcClose(MDB)
head(MeanRLC)
head(SpeciesList)

MeanRLC$sqrtArea <- sqrt(MeanRLC$Area)
head(MeanRLC)

# Red List value per COUNTRY
############################
lmsCountry <- as.data.frame(MeanRLC %>%
	group_by(CountryCode) %>%
	do(lm(NumRLC ~ 1, data = .) %>%
		 	predict.lm(., 
		 						 newdata = data.frame(NumRLC = 0,
		 						                      NumRLC = 1),
		 						 interval = "confidence",
		 						 level = 0.95) %>%
		 	as.data.frame()
	) %>%
	ungroup())
head(lmsCountry)

TableCountry <- lmsCountry %>% 
	arrange(desc(fit))
head(TableCountry)

write.csv(TableCountry, file = "TableCountry.csv", dec = ".", row.names = FALSE, na = "-")

p <- ggplot(lmsCountry, aes(x = reorder(CountryCode, -fit), y = fit)) + 
		 	geom_point() +
		 	geom_pointrange(aes(ymin = lwr, ymax = upr)) +
      xlab("CountryCode") +
      ylab("mRLV") + 
      geom_hline(yintercept = 50, size = 1, linetype = 1) + # , colour = "red"
      geom_hline(yintercept = 30, size = 1, linetype = 2) + # , colour = "orange"
      geom_hline(yintercept = 20, size = 1, linetype = 3) + # , colour = "yellow"
      theme_bw()
p

ggsave(p, file = "MeanRLCperCountry.jpg", dpi = 300, height = 5, width = 10)

# weighted Red List value per SPECIES for Europe (sqrt area as weight)
######################################################################
lmsSpecies <- as.data.frame(MeanRLC %>%
															group_by(SpeciesnameEurope) %>%
															do(lm(NumRLC ~ 1, weights = sqrtArea, data = .) %>%
																 	predict.lm(., 
																 						 newdata = data.frame(NumRLC = 0,
																 						 										 NumRLC = 1),
																 						 interval = "confidence",
																 						 level = 0.95) %>%
																 	as.data.frame()
															) %>%
															ungroup())
head(lmsSpecies)

lmsSpecies2 <- MeanRLC %>% 
	group_by(SpeciesnameEurope) %>%
	summarise(nCountriesRLEur = length(CountryCode))
head(lmsSpecies2)

join1 <- full_join(lmsSpecies, lmsSpecies2, by = "SpeciesnameEurope")
head(join1)

join2 <- full_join(join1, NCountries2, by = "SpeciesnameEurope")
head(join2)

join3 <- full_join(join2, SpeciesList, by = "SpeciesnameEurope")
head(join3)

TableEurope <- join3 %>% 
	select(SpeciesnameEurope, fit, NCountries, nCountriesRLEur, RedListCategoryEurope, EuropeanEndemic, Endemic, EdgeOfRange) %>% 
	group_by(nCountriesRLEur) %>% 
	arrange(desc(fit)) %>% 
	ungroup()
TableEurope$fit <- round(TableEurope$fit, 2)
head(TableEurope)

write.csv(TableEurope, file = "TableEuropesqrtArea.csv", dec = ".", row.names = FALSE, na = "-")

# weighted Red List value per SPECIES for EU (sqrt area as weight)
##################################################################
lmsHDSpecies <- MeanRLC %>% 
	filter(!is.na(EU)) %>% 
	group_by(SpeciesnameEurope) %>%
	do(lm(NumRLC ~ 1, weights = sqrtArea, data = .) %>%
		 	predict.lm(., 
		 						 newdata = data.frame(NumRLC = 0,
		 						 										 NumRLC = 1),
		 						 interval = "confidence",
		 						 level = 0.95) %>%
		 	as.data.frame()
	)%>%
	ungroup()
head(lmsHDSpecies)
lmsHDSpecies <- arrange(lmsHDSpecies, desc(fit))
head(lmsHDSpecies)

lmsHDSpecies2 <- MeanRLC %>% 
	filter(!is.na(EU)) %>% 
	group_by(SpeciesnameEurope) %>%
	summarise(nCountriesRLEU = length(CountryCode))
head(lmsHDSpecies2)
lmsHDSpecies2 <- arrange(lmsHDSpecies2, desc(nCountriesRLEU))
head(lmsHDSpecies2)

join1 <- full_join(lmsHDSpecies, lmsHDSpecies2, by = "SpeciesnameEurope")
head(join1)
join2 <- full_join(join1, SpeciesList, by = "SpeciesnameEurope")
head(join2)
join3 <- full_join(join2, NCountriesEurEU, by = "SpeciesnameEurope")
head(join3)

TableEU <- join3 %>% 
	select(SpeciesnameEurope, fit, nCountriesRLEU, NCountriesEU, RedListCategoryEU, HabitatsDirective) %>% 
	group_by(nCountriesRLEU) %>% 
	arrange(desc(fit), desc(nCountriesRLEU)) %>% 
	ungroup()
TableEU$fit <- round(TableEU$fit, 2)
head(TableEU)

write.csv(TableEU, file = "TableEUsqrtArea.csv", dec = ".", row.names = FALSE, na = "-")

# Join European and EU tables
TableEuropeEU <- full_join(TableEurope, TableEU, by = "SpeciesnameEurope")
head(TableEuropeEU)
nrow(TableEuropeEU)

write.csv(TableEuropeEU, file = "TableEuropeEU.csv", dec = ".", row.names = FALSE, na = "0")

###########################################
# Correlation Area - mean RLC per country #
###########################################

MDB <- odbcConnectAccess2007("ButterflyRedListsEurope.accdb")
CorAreaMeanRLC <- as.data.frame(sqlQuery(MDB, "select * from [qryCorrelationAreaRLC]"))
odbcClose(MDB)
head(CorAreaMeanRLC)

CorAreaMeanRLC$mRLV <- round(CorAreaMeanRLC$mRLV, 0)
CorAreaMeanRLC$sqrtmRLV <- sqrt(CorAreaMeanRLC$mRLV)
CorAreaMeanRLC$Area1 <- CorAreaMeanRLC$Area/1000
CorAreaMeanRLC$sqrtArea <- sqrt(CorAreaMeanRLC$Area1)

head(CorAreaMeanRLC)
hist(CorAreaMeanRLC$mRLV)
hist(CorAreaMeanRLC$sqrtmRLV)

cor.test(CorAreaMeanRLC$mRLV, CorAreaMeanRLC$sqrtArea, method = c("pearson"))

glm.cor <- aov(mRLV ~ sqrtArea
							 , data= CorAreaMeanRLC
							 , family = poisson)
summary(glm.cor)
plot(glm.cor)

glm.cor <- glm(mRLV ~ Area
							 , data= CorAreaMeanRLC
							 , family = poisson)
summary(glm.cor)

gam.cor <- gam(mRLV ~ s(sqrtArea, k = 5)
							 , data= CorAreaMeanRLC
							 , family = poisson)
summary(gam.cor)
plot(gam.cor)

p <- ggplot(CorAreaMeanRLC, aes(x = sqrtArea, y = mRLV)) + geom_point() + geom_smooth(method = "lm", se = TRUE, colour = "black", formula = y ~ splines::ns(x, 1)) + theme_bw() + labs(x = "sqrt(Area)", y = "mRLV") + theme(axis.text.x = element_text(face = "bold", size = 20), axis.text.y = element_text(face = "bold", size = 20)) + theme(axis.title = element_text(face="bold", size=22))
p
ggsave(p, file = "AreamRLV.jpg", dpi = 300, height = 6, width = 10)

```

