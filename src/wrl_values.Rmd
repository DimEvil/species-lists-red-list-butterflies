---
title: "Weighted red list values"
author:
- Dimitri Brosens
- Dirk Maes
date: "18 juli 2018"
output:
  html_document: default
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

This script is used to dynamically calculate the **weighted red list values** for butterflies in Europe.

# Load libraries

```{r}
library(tidyverse)      # To do data science
library(tidylog)        # To provide feedback on dplyr functions
library(magrittr)       # To use %<>% pipes
library(here)           # To find files
library(janitor)        # To clean input data
library(gam)            # To work with generalized additive models
```

# Read source data

The source data is maintained in a Google Spreadsheet and copied by `src/dwc_mapping.Rmd` to `data/raw`, from which we read it:

```{r}
species_list <- read_csv(here::here("data", "raw", "taxa.csv"))
distribution <- read_csv(here::here("data", "raw", "distribution.csv"))
country_info <- read_csv(here::here("data", "raw", "regions.csv"))
regional_threat_scores <- read_csv(here::here("data", "raw", "rlc.csv"))
```

# Taxa per country + regional threat score

`regional_threat_scores` contains a **weight** (in percentage) assigned to a red list category for a country, e.g. `CR` in `Andorra`	= `80`. Add these weights to the distributions and save as `wrl_data`:

```{r}
wrl_data <-
  distribution %>%
  left_join(regional_threat_scores, by = c("rlc" = "rlc", "region_code" = "country_code"))
```

Add country information:

```{r}
wrl_data <-
  wrl_data %>%
  left_join(country_info, by = c("region_code" = "region_code"))
```

Remove non-countries and non-official scientific names:

```{r}
wrl_data <-
  wrl_data %>%
  filter(
    !is.na(country_code), # Excludes Europe, EU27
    is.na(region_name), # Excludes Azores, Canary, Madeira islands
    !is.na(scientific_name) # Excludes regional scientific names without an officially accepted match
  )
```

Save species per country:

```{r}
wrl_data %>%
  group_by(country_code, country_name, part_of_eu, area, population) %>%
  summarize(
    `number_of_species` = n_distinct(scientific_name)
  ) %>%
  select(country_code, number_of_species, country_name, part_of_eu, area, population) %>%
  write_csv(here::here("data", "interim", "species_per_country.csv"), na = "")
```

Save countries per species:

```{r}
wrl_data %>%
  group_by(scientific_name) %>%
  summarize(
    `number_of_countries` = n_distinct(country_code)
  ) %>%
  write_csv(here::here("data", "interim", "country_per_species.csv"), na = "")
```

# Recreate Ncountry dataframes used in original script

NCountries is Raw Data + info on countries per species

```{r}
NCountries <- distribution %>%
              left_join(country_per_species, by = c("raw_speciesname_europe"="raw_speciesname_europe")) %>%
              left_join(country_info, by = c("raw_country_code"="CountryCode"))

View(NCountries)


```

N is for number of coutries, we did this already....
country_per_species is NCountries2

```{r}
NCountries2 <- NCountries %>% 
	group_by(raw_speciesname_europe) %>%
	summarise(NCountries = length(raw_country_code))
head(NCountries2)
nrow(NCountries2)

NCountriesEU <- NCountries %>% 
	filter(!is.na(EU))

NCountries2EU <- NCountriesEU %>% 
	group_by(raw_speciesname_europe) %>%
	summarise(NCountriesEU = length(raw_country_code))

NCountriesEurEU <- full_join(NCountries2, NCountries2EU, by = "raw_speciesname_europe")
```

# Weighted Red list values

We calculate the mean RLC_country and left join the country information.

```{r}
MeanRLCValue_per_country <- raw_data %>%
      group_by(raw_country_code) %>%
      summarise_at(vars(RLCNum),funs(mean(., na.rm=TRUE))) %>%
      left_join(country_info, by = c("raw_country_code"="CountryCode"))

head(MeanRLCValue_per_country)
head(raw_data)

write_csv(MeanRLCValue_per_country, here("data", "processed", "wrl_values_per_country.csv"), na = "")
```

We calculate the mean RLC_species and left join the country information.

```{r}
MeanRLCValue_per_species <- raw_data %>%
      group_by (raw_speciesname_europe) %>%
      summarise_at(vars(RLCNum),funs(mean(., na.rm=TRUE))) %>%
      rename(RLCNum_species = RLCNum) %>%
      left_join(raw_data, by = c("raw_speciesname_europe"="raw_speciesname_europe")) %>%
      left_join(country_info, by = c("raw_country_code"="CountryCode")) %>%
      drop_na(RLCNum_species)
MeanRLCValue_per_species$sqrtArea <- sqrt(MeanRLCValue_per_species$Area)

head(MeanRLCValue_per_species)

write_csv(MeanRLCValue_per_species, here("data", "processed", "wrl_values_per_species.csv"), na = "")
```

# Trying to proceed with the original script by Dirk

```{r}
MDB <- raw_data
MeanRLC <- MeanRLCValue_per_country %<>%
           drop_na(RLCNum)

MeanRLC$sqrtArea <- sqrt(MeanRLC$Area)
head(MeanRLC)

write_csv(MeanRLC, here("data", "interim", "wrl_values_per_sqrt_country.csv"), na = "")
```

# Linear model created on MeanRLCValue_per_species. Use ungrouped MeanRLCValue_per_species as dataframe

```{r}
lmsCountry <-(as.data.frame(MeanRLCValue_per_species %>%
	group_by(raw_country_code) %>%
	 drop_na(RLCNum) %>%
	do(lm(RLCNum ~ 1, data = .data) %>%
		 	predict.lm(., 
		 						 newdata = data.frame(RLCNumA = 0,
		 						                      RLCNumB = 1),
		 						 interval = "confidence",
		 						 level = 0.95) %>%
		 	as.data.frame()
	) %>%
	ungroup()))
head(lmsCountry)
```

```{r}
MeanRLCperCountry <- ggplot(lmsCountry, aes(x = reorder(raw_country_code, -fit), y = fit)) + 
		 	geom_point() +
		 	geom_pointrange(aes(ymin = lwr, ymax = upr)) +
      xlab("CountryCode") +
      ylab("mRLV") + 
      geom_hline(yintercept = 50, size = 1, linetype = 1) + # colour = "red")
      geom_hline(yintercept = 30, size = 1, linetype = 2) + # , colour = "orange"
      geom_hline(yintercept = 20, size = 1, linetype = 3) + # , colour = "yellow"
      theme_bw()
MeanRLCperCountry

ggsave(MeanRLCperCountry, file = here("images", "mean_rlv_per_country.jpg"), device = "jpeg", dpi = 300, height = 5, width = 10)
```
 
# weighted Red List value per SPECIES for Europe (sqrt area as weight)
 
```{r}
lmsSpecies <- as.data.frame(MeanRLCValue_per_species %>%
															group_by(raw_speciesname_europe) %>%
															drop_na(RLCNum) %>%
															do(lm(RLCNum ~ 1, weights = sqrtArea, data = .) %>%
															  	predict.lm(., 
																 						 newdata = data.frame(RLCNumA = 0,
																 						 										  RLCNumB = 1),
																 						 interval = "confidence",
																 						 level = 0.95) %>%
																 	as.data.frame()
															) %>%
															ungroup())
head(lmsSpecies)
```

```{r}
lmsSpecies2 <- MeanRLCValue_per_species %>% 
	group_by(raw_speciesname_europe) %>%
	summarise(nCountriesRLEur = length(raw_country_code))
head(lmsSpecies2)

join1 <- full_join(lmsSpecies, lmsSpecies2, by = "raw_speciesname_europe")
head(join1)

join2 <- full_join(join1, NCountries2, by = "raw_speciesname_europe")
head(join2)

join3 <- full_join(join2, specieslist, by = c("raw_speciesname_europe"="SpeciesnameEurope"))
head(join3)

TableEurope <- join3 %>% 
	select(raw_speciesname_europe, fit, NCountries, nCountriesRLEur, RedListCategoryEurope, EuropeanEndemic, Endemic, EdgeOfRange) %>% 
	group_by(nCountriesRLEur) %>% 
	arrange(desc(fit)) %>% 
	ungroup()
TableEurope$fit <- round(TableEurope$fit, 2)
head(TableEurope)
```

# weighted Red List value per SPECIES for EU (sqrt area as weight)

```{r}
lmsHDSpecies <- MeanRLCValue_per_species %>% 
	filter(!is.na(EU)) %>% 
	group_by(raw_speciesname_europe) %>%
	do(lm(RLCNum_species ~ 1, weights = sqrtArea, data = .) %>%
		 	predict.lm(., 
		 						 newdata = data.frame(RLCNum_species = 0,
		 						 										 RLCNum_species = 1),
		 						 interval = "confidence",
		 						 level = 0.95) %>%
		 	as.data.frame()
	)%>%
	ungroup()
head(lmsHDSpecies)
lmsHDSpecies <- arrange(lmsHDSpecies, desc(fit))
head(lmsHDSpecies)

lmsHDSpecies2 <- MeanRLCValue_per_species %>% 
	filter(!is.na(EU)) %>% 
	group_by(raw_speciesname_europe) %>%
	summarise(nCountriesRLEU = length(raw_country_code))
head(lmsHDSpecies2)
lmsHDSpecies2 <- arrange(lmsHDSpecies2, desc(nCountriesRLEU))
head(lmsHDSpecies2)

join1 <- full_join(lmsHDSpecies, lmsHDSpecies2, by = "raw_speciesname_europe")
head(join1)
join2 <- full_join(join1, specieslist, by = c("raw_speciesname_europe"="SpeciesnameEurope"))
head(join2)
join3 <- full_join(join2, NCountriesEurEU, by = "raw_speciesname_europe")
head(join3)

TableEU <- join3 %>% 
	select(raw_speciesname_europe, fit, nCountriesRLEU, NCountriesEU, RedListCategoryEU, HabitatsDirective) %>% 
	group_by(nCountriesRLEU) %>% 
	arrange(desc(fit), desc(nCountriesRLEU)) %>% 
	ungroup()
TableEU$fit <- round(TableEU$fit, 2)
head(TableEU)

write_csv(TableEU, here("data", "processed", "wrl_values_eu_sqrt_area.csv"), na = "")

# Join European and EU tables
TableEuropeEU <- full_join(TableEurope, TableEU, by = "raw_speciesname_europe")
head(TableEuropeEU)
nrow(TableEuropeEU)

write_csv(TableEuropeEU, here("data", "processed", "wrl_values_eu.csv"), na = "0")
```

# Correlation Area - mean RLC per country 

```{r}
CorAreaMeanRLC <- MeanRLC

head(CorAreaMeanRLC)

CorAreaMeanRLC$RLCNum <- round(CorAreaMeanRLC$RLCNum, 0)
CorAreaMeanRLC$sqrtRLCNum <- sqrt(CorAreaMeanRLC$RLCNum)
CorAreaMeanRLC$Area1 <- CorAreaMeanRLC$Area/1000
CorAreaMeanRLC$sqrtArea <- sqrt(CorAreaMeanRLC$Area1)

head(CorAreaMeanRLC)
hist(CorAreaMeanRLC$RLCNum)
hist(CorAreaMeanRLC$sqrtRLCNum)

cor.test(CorAreaMeanRLC$RLCNum, CorAreaMeanRLC$sqrtArea, method = c("pearson"))

glm.cor <- aov(RLCNum ~ sqrtArea

							 , data= CorAreaMeanRLC
							 , family = poisson)
summary(glm.cor)
plot(glm.cor)


glm.cor <- glm(RLCNum ~ Area, data = CorAreaMeanRLC, family = poisson)
summary(glm.cor)


gam.cor <- gam(RLCNum ~ s(sqrtArea), data = CorAreaMeanRLC, family = poisson)
summary(gam.cor)
plot(gam.cor)

AreamRLV <- ggplot(CorAreaMeanRLC, aes(x = sqrtArea, y = RLCNum)) + geom_point() + geom_smooth(method = "lm", se = TRUE, colour = "black", formula = y ~ splines::ns(x, 1)) + theme_bw() + labs(x = "sqrt(Area)", y = "mRLV") + theme(axis.text.x = element_text(face = "bold", size = 20), axis.text.y = element_text(face = "bold", size = 20)) + theme(axis.title = element_text(face="bold", size=22))

AreamRLV
ggsave(AreamRLV, file = here("images/mean_rlv_per_sqrt_area.jpg"), device = "jpeg", dpi = 300, height = 6, width = 10)
```
