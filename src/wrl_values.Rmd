---
title: "Weighted red list values"
author:
- Dimitri Brosens
- Dirk Maes
date: "18 juli 2018"
output:
  html_document: default
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

[maes_2019]: https://doi.org/10.1007/s10841-019-00127-z

This script is used to dynamically calculate the **weighted red list values** for butterflies in Europe, use for [Maes et al. (2019)][maes_2019].

# Load libraries

```{r}
library(tidyverse)      # To do data science
library(tidylog)        # To provide feedback on dplyr functions
library(magrittr)       # To use %<>% pipes
library(here)           # To find files
library(janitor)        # To clean input data
library(gam)            # To work with generalized additive models
```

# Read source data

The source data is maintained in a Google Spreadsheet and copied by `src/dwc_mapping.Rmd` to `data/raw`, from which we read it:

```{r}
species_list <- read_csv(here::here("data", "raw", "taxa.csv"))
distribution <- read_csv(here::here("data", "raw", "distribution.csv"))
country_info <- read_csv(here::here("data", "raw", "regions.csv"))
regional_threat_scores <- read_csv(here::here("data", "raw", "rlc.csv"))
```

# Pre-processing
# Create species list with Europe/EU red list and endemic status

Create a dataframe of the taxa per country (= distributions) and associate with country information and regional threat score. Regional threat score is a **weight** (in percentage) assigned to a red list category (rlc) for a country, e.g. `CR` in `Andorra`	= `80`.
Create lookup of red list status in Europe and European Union:

```{r}
analysis_data <-
eur <-
  distribution %>%
  left_join(country_info, by = "region_code") %>%
  left_join(regional_threat_scores, by = c("rlc", "region_code" = "country_code")) # Only associate region_code that are country_code (excluding islands, etc.)
  filter(region_code == "EUR") %>%
  filter(use == "y") %>%
  select(scientific_name, rlc, endemic) %>%
  rename(rlc_eur = rlc, endemic_eur = endemic)

eu27 <-
  distribution %>%
  filter(region_code == "EU27") %>%
  filter(use == "y") %>%
  select(scientific_name, rlc, endemic) %>%
  rename(rlc_eu27 = rlc, endemic_eu27 = endemic)
```

Only include taxa to be used for analysis (column `use`, based on breeding, regular migrant, regionally extinct, etc.):
Create lookup of endemic status:

```{r}
analysis_data %<>% filter(use == "y")
endemic <-
  distribution %>%
  filter(!is.na(endemic)) %>%
  filter(!region_code %in% c("EUR", "EU27")) %>% # Treated separately, see above
  group_by(scientific_name) %>%
  summarize(
    endemic = paste(unique(endemic), collapse = "|")
  )
```

Exclude regional scientific names without an officially accepted match:
Join information together with species list:

```{r}
analysis_data %<>% filter(!is.na(scientific_name)) # 1 rows (with use="y")
eu_species_list <-
  species_list %>%
  left_join(eur, by = "scientific_name") %>%
  left_join(eu27, by = "scientific_name") %>%
  left_join(endemic, by = "scientific_name")
```

Remove duplicated rows (e.g. two local scientific names that were mapped to one):
Number of taxa should remain the same:

```{r}
analysis_data %<>% distinct(scientific_name, region_code, status, rlc, .keep_all = TRUE) # 17 rows (with use="y")
nrow(species_list) == nrow(eu_species_list) # Expect TRUE
```

Show any remaining scientific_name + region_code duplicates (should be 0):
Save file:

```{r}
analysis_data %>% get_dupes(scientific_name, region_code)
write_csv(eu_species_list, here::here("data", "interim", "eu_species_list.csv"), na = "")
```

Create lookup of red list status for Europe and European Union:

```{r}
rlc_eur <-
  analysis_data %>%
  filter(region_code == "EUR") %>%
  select(scientific_name, rlc) %>%
  rename(rlc_eur = rlc)

rlc_eu27 <-
  analysis_data %>%
  filter(region_code == "EU27") %>%
  select(scientific_name, rlc) %>%
  rename(rlc_eu27 = rlc)
```

Associated red list status for Europe and European Union:

```{r}
analysis_data %<>%
  left_join(rlc_eur, by = "scientific_name") %>%
  left_join(rlc_eu27, by = "scientific_name")
```

Exclude non-countries, islands, and non-official scientific names. Keep island groups:

```{r}
analysis_data %<>% filter(
  !is.na(country_code), # Exclude Europe, EU27, Macaronesia
  !str_detect(region_code, "MA_AZ_"), # Exclude Azores islands, keep island group MA_AZ
  !str_detect(region_code, "MA_CA_"), # Exclude Canary islands, keep island group MA_CA
  !str_detect(region_code, "MA_MA_") # Exclude Madeira islands, keep island group MA_MA
)
```

Remove unnecessary fields and rename `region_code` to `country_code` (including countries + island groups):

```{r}
analysis_data %<>%
  select(
    scientific_name,
    status,
    endemic,
    rlc,
    rlc_numeric,
    rlc_eur,
    rlc_eu27,
    region_code,
    country_name,
    part_of_eu,
    area
  ) %>%
  rename(country_code = region_code)
```

Save file:

```{r}
write_csv(analysis_data, here::here("data", "interim", "analysis_data.csv"), na = "")
```

# Species per country

```{r}
species_per_country <-
  analysis_data %>%
  group_by(country_name, country_code) %>%
  summarize(
    `number_of_species` = n_distinct(scientific_name)
  )

write_csv(species_per_country, here::here("data", "processed", "wrl", "species_per_country.csv"), na = "")
```

# Mean red list value per country (cRLV)

```{r}
mean_rlv_per_country <-
  analysis_data %>%
  group_by(country_name, country_code) %>%
  summarize(
    mean_rlv = mean(rlc_numeric, na.rm = TRUE)
  )

write_csv(mean_rlv_per_country, here::here("data", "processed", "wrl", "mean_rlv_per_country.csv"), na = "")
```

# Mean red list value per species (wsRLV)

```{r}
weighted_rlv_per_species <-
  analysis_data %>%
  group_by(scientific_name) %>%
  summarize(
    weighted_species_rlv = mean(rlc_numeric, na.rm = TRUE)
  )

write_csv(weighted_rlv_per_species, here::here("data", "processed", "wrl", "weighted_rlv_per_species.csv"), na = "")
```

```{r}

```



# Linear model for weighted red list value per country

```{r}
lms_country <-
  analysis_data %>%
	drop_na(rlc_numeric) %>%
  group_by(country_code) %>%
	do(
	  lm(rlc_numeric ~ 1, data = .data) %>%
		predict.lm(
		  ., 
		 	newdata = data.frame(RLCNumA = 0, RLCNumB = 1),
		 	interval = "confidence",
		 	level = 0.95
		) %>%
		as.data.frame()
	)
```

```{r}
mean_rlc_per_country <- ggplot(lms_country, aes(x = reorder(country_code, -fit), y = fit)) + 
  geom_point() +
  geom_pointrange(aes(ymin = lwr, ymax = upr)) +
  xlab("CountryCode") +
  ylab("mRLV") + 
  geom_hline(yintercept = 50, size = 1, linetype = 1) + # colour = "red")
  geom_hline(yintercept = 30, size = 1, linetype = 2) + # , colour = "orange"
  geom_hline(yintercept = 20, size = 1, linetype = 3) + # , colour = "yellow"
  theme_bw()

mean_rlc_per_country

ggsave(
  mean_rlc_per_country,
  file = here::here("images", "mean_rlv_per_country.jpg"),
  device = "jpeg",
  dpi = 300,
  height = 5,
  width = 10
)
```

# Weighted red list value per species (wsRLV)

```{r}

```


```{r}
weighted_rlv_per_species <-
  analysis_data %>%
  mutate(sqrt_area = sqrt(area)) %>%
  group_by(scientific_name) %>%
  summarize(
    weighted_rlv = mean(rlc_numeric/sqrt_area, na.rm = TRUE)
  )

write_csv(weighted_rlv_per_species, here::here("data", "processed", "wrl", "weighted_rlv_per_species.csv"), na = "")
```




# Correlation area - mean RLC per country 

```{r}
CorAreaMeanRLC <- taxa_country_rlv %>%
  select(scientific_name, rlc_numeric, area)

CorAreaMeanRLC$RLCNum <- round(CorAreaMeanRLC$rlc_numeric, 0)
CorAreaMeanRLC$sqrtRLCNum <- sqrt(CorAreaMeanRLC$rlc_numeric)
CorAreaMeanRLC$Area1 <- CorAreaMeanRLC$area/1000
CorAreaMeanRLC$sqrtArea <- sqrt(CorAreaMeanRLC$Area1)

hist(CorAreaMeanRLC$RLCNum)
hist(CorAreaMeanRLC$sqrtRLCNum)

cor.test(CorAreaMeanRLC$RLCNum, CorAreaMeanRLC$sqrtArea, method = c("pearson"))

glm.cor <- aov(RLCNum ~ sqrtArea

							 , data= CorAreaMeanRLC
							 , family = poisson)
summary(glm.cor)
plot(glm.cor)

glm.cor <- glm(RLCNum ~ Area, data = CorAreaMeanRLC, family = poisson)
summary(glm.cor)

gam.cor <- gam(RLCNum ~ s(sqrtArea), data = CorAreaMeanRLC, family = poisson)
summary(gam.cor)
plot(gam.cor)

AreamRLV <- ggplot(CorAreaMeanRLC, aes(x = sqrtArea, y = RLCNum)) + geom_point() + geom_smooth(method = "lm", se = TRUE, colour = "black", formula = y ~ splines::ns(x, 1)) + theme_bw() + labs(x = "sqrt(Area)", y = "mRLV") + theme(axis.text.x = element_text(face = "bold", size = 20), axis.text.y = element_text(face = "bold", size = 20)) + theme(axis.title = element_text(face="bold", size=22))

AreamRLV
ggsave(AreamRLV, file = here("images/mean_rlv_per_sqrt_area.jpg"), device = "jpeg", dpi = 300, height = 6, width = 10)
```
